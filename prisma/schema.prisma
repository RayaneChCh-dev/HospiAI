// HospiAI - Prisma Database Schema
// Medical AI Platform with secure authentication and token-based access

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User model for authentication
model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  password           String    // Hashed with bcrypt
  firstname          String?   // Optional until profile completion
  surname            String?   // Optional until profile completion
  sex                String?   // Optional until profile completion
  age                Int?      // Optional until profile completion
  phoneNumber        String?   // Optional until profile completion
  reservationCount   Int       @default(0)
  profileCompletedAt DateTime? // Date when profile was completed
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  tokens            TempToken[]
  appointments      Appointment[]
  mcpTokens         MCP[]
  userSubscription  UserSubscription?

  @@index([email])
  @@index([phoneNumber])
}

// Temporary token for external access (e.g., Mistral MCP)
model TempToken {
  id        String   @id @default(cuid())
  token     String   @unique @default(cuid())
  userId    String
  expiresAt DateTime // 7 days from creation
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}
// Hospital model for storing hospital information
model Hospital {
  id            String   @id @default(cuid())
  name          String
  city          String
  distanceKm    Float?   // Distance from reference point (optional)
  address       String?
  phoneNumber   String?
  email         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  appointments  Appointment[]
  hospitalStatus HospitalStatus?

  @@index([city])
  @@index([name])
}

// Hospital Status model for real-time availability
model HospitalStatus {
  id            String   @id @default(cuid())
  hospitalId    String   @unique
  availableBeds Int      @default(0)
  icuBeds       Int      @default(0)
  ventilators   Int      @default(0)
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())

  // Relations
  hospital      Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)

  @@index([hospitalId])
}

// Appointment model for hospital reservations
model Appointment {
  id                 String   @id @default(cuid())
  userId             String   // Patient who made the appointment
  hospitalId         String
  description        String?
  appointmentDateTime DateTime // Date and time of the appointment
  status             String   @default("pending") // pending, confirmed, cancelled, completed
  createdAt          DateTime @default(now()) // When the appointment was created
  updatedAt          DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  hospital    Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([hospitalId])
  @@index([appointmentDateTime])
  @@index([status])
}
model MCP {
  id        String   @id @default(cuid())
  userId    String
  tokenMcp  String   @unique
  name      String   // User-friendly name for the token
  scopes    String[] // Array of permission scopes
  expiresAt DateTime // Token expiration date
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenMcp])
  @@index([expiresAt])
}

// Subscription Plans model
model Subscription {
  id          String   @id @default(cuid())
  name        String   @unique // "Free", "Premium", "Pay Per Use"
  slug        String   @unique // "free", "premium", "pay_per_use"
  pricePerMonth Float  // 0, 4.99, or variable for pay-per-use
  features    Json     // Store features as JSON array
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userSubscriptions UserSubscription[]

  @@index([slug])
}

// User Subscription model - links users to their subscription plan
model UserSubscription {
  id              String    @id @default(cuid())
  userId          String    @unique // One subscription per user
  subscriptionId  String
  status          String    @default("active") // active, cancelled, expired
  startDate       DateTime  @default(now())
  endDate         DateTime? // Null for active subscriptions

  // Usage tracking for Free plan
  appointmentsThisMonth Int @default(0) // Track appointments for free users (limit 1/month)
  lastResetDate   DateTime  @default(now()) // Track when to reset monthly counter

  // Pay-per-use tracking
  payPerUseBalance Float @default(0) // Track pay-per-use charges

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
}

